<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Electron IDE</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="./index.css" rel="stylesheet">
</head>
<body>
  <div class="container-fluid p-0">
    <div class="row g-0" style="height: 100vh;">
      <!-- Activity Bar (left sidebar with icons) -->
      <div class="activity-bar">
        <div class="activity-icon active" title="Explorer" id="explorerIcon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3h18v18H3zM9 3v18"/></svg>
        </div>
        <div class="activity-icon" title="Search" id="searchIcon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        </div>
        <div class="activity-icon" title="Source Control" id="sourceIcon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="18" cy="18" r="3"></circle><circle cx="6" cy="6" r="3"></circle><path d="M13 6h3a2 2 0 0 1 2 2v7"></path><line x1="6" y1="9" x2="6" y2="21"></line></svg>
        </div>
        <div class="activity-icon" title="Run and Debug" id="runanddebugIcon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <polygon points="5,3 19,12 5,21" fill="currentColor"/>
          </svg>
        </div>
        <div class="activity-icon" title="Extensions" id="extensionsIcon">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <rect x="4" y="4" width="6" height="6" rx="1"></rect>
            <rect x="14" y="4" width="6" height="6" rx="1"></rect>
            <rect x="4" y="14" width="6" height="6" rx="1"></rect>
            <rect x="14" y="14" width="6" height="6" rx="1"></rect>
          </svg>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="col-2 sidebar active" id="explorer">
        <div class="sidebar-header">
          <span>EXPLORER</span>
          <button id="openDirectory" class="btn-sidebar" title="Open Folder">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path></svg>
          </button>
        </div>
        
        <div id="directoryPath" class="directory-path">No directory selected</div>
        
        <div class="d-flex px-2 mt-2 mb-2">
          <button id="newFile" class="btn-sidebar" title="New File">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>
          </button>
          <button id="runCode" class="btn-sidebar" title="Run Code">
            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
          </button>
        </div>
        
        <div id="fileExplorer" class="file-explorer">
          <!-- Files and folders will be populated here -->
        </div>
      </div>
      <div class="col-2 sidebar" id="search">
        <div class="sidebar-header">
          <span>Search</span>
        </div>
      </div>
      <div class="col-2 sidebar" id="source">
        <div class="sidebar-header">
          <span>Source Control</span>
        </div>
      </div>
      <div class="col-2 sidebar" id="runanddebug">
        <div class="sidebar-header">
          <span>Run & Debug</span>
        </div>
      </div>
      <div class="col-2 sidebar" id="extensions">
        <div class="sidebar-header">
          <span>Programming Tools</span>
        </div>
      </div>

      <!-- Main content -->
      <div class="col d-flex flex-column main-content">
        <div class="toolbar">
          <button id="saveButton" class="btn-toolbar" disabled>
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-right: 4px;"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>
            Save
          </button>
        </div>
        
        <div id="editorTabs" class="editor-tabs" style="border-color: aliceblue;">
          <!-- Tabs will be added dynamically -->
        </div>
        
        <div class="editor-area">
          <div id="lineNumbers" class="line-numbers"></div>
          <div class="editor-container">
            <textarea id="editor" spellcheck="false"></textarea>
            <div id="ghostText"></div>
          </div>
        </div>
        
        <div class="terminal">
          <div class="terminal-header">
            <div>TERMINAL</div>
            <button id="clearTerminal" class="btn-sidebar">
              <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
            </button>
          </div>
          <div id="terminalOutput" class="terminal-output">
            $ Welcome to Electron IDE Terminal<br>
          </div>
        </div>
        
        <div class="status-bar">
          <div id="cursorPosition" class="status-item">Ln 1, Col 1</div>
          <div class="status-item">Spaces: 2</div>
          <div class="status-item">UTF-8</div>
          <div id="fileTypeIndicator" class="status-item"></div>
          <div id="statusIndicator" class="ms-auto status-item">Ready</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Dialog -->
  <div id="input-modal" class="modal" style="display: none;">
    <div class="modal-content">
      <h3 id="modal-title">New File</h3>
      <p id="modal-message">Enter new file name:</p>
      <input type="text" id="modal-input" placeholder="filename.txt">
      <div class="modal-buttons">
        <button id="modal-cancel">Cancel</button>
        <button id="modal-confirm">Create</button>
      </div>
    </div>
  </div>

<script src="./renderer.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    // DOM Elements
    const editor = document.getElementById('editor');
    const ghostText = document.getElementById('ghostText');
    const cursorPosition = document.getElementById('cursorPosition');
    
    // Current suggestion state
    let currentSuggestion = '';
    let hasSuggestion = false;
    
    // Utility Functions
    function synchronizeScrolling() {
      ghostText.scrollTop = editor.scrollTop;
      ghostText.scrollLeft = editor.scrollLeft;
    }
    
    function updateGhostText() {
      if (!hasSuggestion) {
        ghostText.textContent = '';
        return;
      }
      
      const cursorPos = editor.selectionStart;
      const textBeforeCursor = editor.value.substring(0, cursorPos);
      
      // Match number of newlines to align ghost text properly
      const lines = textBeforeCursor.split('\n');
      const lineBreaks = lines.length - 1;
      const lastLineContent = lines[lines.length - 1];
      
      // Create ghost text content with proper indentation
      const padding = '\n'.repeat(lineBreaks) + ' '.repeat(lastLineContent.length);
      ghostText.textContent = padding + currentSuggestion;
      
      synchronizeScrolling();
    }
    
    function acceptSuggestion() {
      if (!hasSuggestion) return false;
      
      const cursorPos = editor.selectionStart;
      editor.value = editor.value.substring(0, cursorPos) + 
                     currentSuggestion + 
                     editor.value.substring(cursorPos);
      
      // Move cursor to end of inserted text
      editor.selectionStart = editor.selectionEnd = cursorPos + currentSuggestion.length;
      
      // Clear suggestion
      currentSuggestion = '';
      hasSuggestion = false;
      updateGhostText();
      
      return true;
    }
    
    function updateCursorPosition() {
      if (!editor) return;
      
      const text = editor.value;
      const caret = editor.selectionStart;
      
      // Calculate line and column
      let line = 1;
      let col = 1;
      
      for (let i = 0; i < caret; i++) {
        if (text[i] === '\n') {
          line++;
          col = 1;
        } else {
          col++;
        }
      }
      
      cursorPosition.textContent = `Ln ${line}, Col ${col}`;
      
      // If cursor moved, update ghost text positioning
      if (hasSuggestion) {
        updateGhostText();
      }
    }
    
    // Get suggestion based on current context
    function fetchInlineSuggestion() {
      // Get context for suggestion
      const cursorPos = editor.selectionStart;
      const precedingText = editor.value.substring(0, cursorPos);
      
      // Call API to get suggestions
      const key = ''; // Add your API key here
      
      if (!key) {
        console.warn('API key not provided. Please add your Gemini API key.');
        // For testing, provide a mock suggestion
        mockSuggestion(precedingText);
        return;
      }
      
      fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          contents: [{
            parts: [{ text: "Complete this code: " + precedingText }]
          }]
        })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }
        return response.json();
      })
      .then(response => {
        if (response.candidates && response.candidates.length > 0) {
          const suggestion = response.candidates[0].content?.parts?.[0]?.text || '';
          if (suggestion) {
            currentSuggestion = suggestion;
            hasSuggestion = true;
            updateGhostText();
          }
        }
      })
      .catch(err => {
        console.error('Suggestion error:', err);
        // Fallback to mock suggestion
        mockSuggestion(precedingText);
      });
    }
    
    // Mock suggestion for testing without API key
    function mockSuggestion(text) {
      // Simple mock suggestions based on context
      const mockSuggestions = {
        'function ': 'myFunction() {\n  \n}',
        'if ': '(condition) {\n  \n}',
        'for ': '(let i = 0; i < array.length; i++) {\n  \n}',
        'const ': 'variable = ',
        'let ': 'variable = ',
        'console.': 'log("")',
        '<div': ' class="">'
      };
      
      // Find a matching prefix
      for (const prefix in mockSuggestions) {
        if (text.trim().endsWith(prefix)) {
          currentSuggestion = mockSuggestions[prefix];
          hasSuggestion = true;
          updateGhostText();
          return;
        }
      }
      
      // Default suggestion
      if (text.trim().length > 5) {
        const lastWord = text.split(/\s/).pop();
        if (lastWord && lastWord.length > 2) {
          currentSuggestion = lastWord + 'Suggestion';
          hasSuggestion = true;
          updateGhostText();
        }
      }
    }
    
    // Event Listeners
    if (editor) {
      // Synchronize scrolling
      editor.addEventListener('scroll', synchronizeScrolling);
      
      // Track cursor position
      editor.addEventListener('click', () => {
        updateCursorPosition();
        fetchInlineSuggestion();
      });
      
      editor.addEventListener('keyup', (e) => {
        updateCursorPosition();
        
        // Don't trigger on special keys
        const nonTriggerKeys = ['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 
                                'Shift', 'Control', 'Alt', 'Meta', 'CapsLock', 
                                'Escape', 'Tab', 'Enter'];
        
        if (!nonTriggerKeys.includes(e.key)) {
          // Clear current suggestion
          currentSuggestion = '';
          hasSuggestion = false;
          ghostText.textContent = '';
          
          // Fetch new suggestion after typing pause
          clearTimeout(editor.suggestionTimer);
          editor.suggestionTimer = setTimeout(() => {
            fetchInlineSuggestion();
          }, 500); // Delay to avoid too many requests
        }
      });
      
      editor.addEventListener('keydown', (e) => {
        // Accept suggestion with Tab
        if (e.key === 'Tab' && hasSuggestion) {
          e.preventDefault();
          acceptSuggestion();
        }
      });
      
      // Initial setup
      editor.value = '// Start typing here\n// Press Tab to accept suggestions\n';
      editor.focus();
      updateCursorPosition();
    }
    
    // Initialize sidebar functionality
    const icons = document.querySelectorAll('.activity-icon');
    const sidebars = {
      explorer: document.getElementById('explorer'),
      search: document.getElementById('search'),
      source: document.getElementById('source'),
      runanddebug: document.getElementById('runanddebug'),
      extensions: document.getElementById('extensions')
    };
    
    function clearActiveStates() {
      icons.forEach(icon => icon.classList.remove('active'));
      Object.values(sidebars).forEach(sidebar => sidebar.classList.remove('active'));
    }
    
    const iconToSidebar = {
      explorerIcon: 'explorer',
      searchIcon: 'search',
      sourceIcon: 'source',
      runanddebugIcon: 'runanddebug',
      extensionsIcon: 'extensions'
    };
    
    icons.forEach(icon => {
      icon.addEventListener('click', () => {
        const id = icon.getAttribute('id');
        const targetId = iconToSidebar[id];
        
        if (targetId && sidebars[targetId]) {
          clearActiveStates();
          icon.classList.add('active');
          sidebars[targetId].classList.add('active');
        }
      });
    });
    
    // Clear terminal button
    const clearTerminalBtn = document.getElementById('clearTerminal');
    const terminalOutput = document.getElementById('terminalOutput');
    
    if (clearTerminalBtn && terminalOutput) {
      clearTerminalBtn.addEventListener('click', () => {
        terminalOutput.innerHTML = '$ Terminal cleared<br>';
      });
    }
  });
</script>
</body>
</html>